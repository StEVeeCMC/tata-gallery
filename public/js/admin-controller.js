// Generated by CoffeeScript 1.3.3
(function() {

  define(['jquery', 'jquery.ui'], function($) {
    var AdminController;
    AdminController = (function() {

      function AdminController() {
        this.isAdmin = false;
        this.checkAuthenticateSync();
      }

      AdminController.prototype.checkAuthenticateSync = function() {
        var _this = this;
        $.ajax({
          type: 'GET',
          url: '/login',
          async: false,
          success: function(data) {
            return _this.isAdmin = !!data.user;
          }
        });
        return this;
      };

      AdminController.prototype.removeImage = function(collectionName, imageURL, successCB) {
        $.get("/remove/" + collectionName + "/" + imageURL, successCB);
        return this;
      };

      AdminController.prototype.upImage = function(collectionName, imageURL, successCB) {
        $.post('/up', {
          collectionName: collectionName,
          imageURL: imageURL
        }, successCB);
        return this;
      };

      AdminController.prototype.downImage = function(collectionName, imageURL, successCB) {
        $.post('/down', {
          collectionName: collectionName,
          imageURL: imageURL
        }, successCB);
        return this;
      };

      AdminController.prototype.changeDescription = function(collectionName, description, successCB) {
        $.post('/collectionDescription', {
          collectionName: collectionName,
          description: description
        }, successCB);
        return this;
      };

      AdminController.prototype.changeType = function(collectionName, type, successCB) {
        $.post('/collectionType', {
          collectionName: collectionName,
          type: type
        }, successCB);
        return this;
      };

      AdminController.prototype.getCollectionType = function() {
        return window.location.href.split('=')[1];
      };

      AdminController.prototype.uploadForm = function($fileForm) {
        var formData;
        formData = new FormData($fileForm[0]);
        $.ajax({
          type: 'POST',
          url: '/upload',
          xhr: function() {
            var myXhr;
            myXhr = $.ajaxSettings.xhr();
            return myXhr;
          },
          data: formData,
          cache: false,
          contentType: false,
          processData: false
        });
        return this;
      };

      AdminController.prototype.activateAdminControls = function() {
        this.createLoginForm();
        if (!this.isAdmin) {
          return;
        }
        $('.admin-control').removeClass('admin-control');
        this.activateLogoutButton();
        this.createUploadForm();
        return this;
      };

      AdminController.prototype.activateLogoutButton = function() {
        $('#login').hide();
        $('#logout').show();
        return this;
      };

      AdminController.prototype.createUploadForm = function() {
        var $addFileForm;
        $addFileForm = $('<form enctype="multipart/form-data" method="post">' + '<input type="file" name="upload" multiple="multiple" class="file">' + '<input type="text" name="name" class="file">' + '<input type="text" name="type" class="file">' + '</form>');
        $('.footer').append($addFileForm);
        $('#new-collection-add').click(function() {
          var $cNameInput, $fileInput, $typeInput;
          $fileInput = $addFileForm.find('input[type=file]').val("");
          $cNameInput = $addFileForm.find('input[name=name]').val("");
          $typeInput = $addFileForm.find('input[name=type]').val(getCollectionType());
          $fileInput.change(function() {
            $fileInput.unbind();
            if ($fileInput.val() !== "") {
              return uploadForm($addFileForm);
            }
          });
          return $fileInput.click();
        });
        return this;
      };

      AdminController.prototype.createLoginForm = function() {
        var $loginDialogBox,
          _this = this;
        $loginDialogBox = $('#login-dialog').tmpl();
        $('#login').click(function() {
          return $loginDialogBox.dialog({
            dialogClass: "login-form-dialog",
            buttons: {
              "Ok": function() {
                var formData;
                formData = new FormData();
                formData.append('username', $('#username').val());
                formData.append('password', $('#password').val());
                return $.ajax({
                  url: '/login',
                  type: 'POST',
                  data: formData,
                  error: function() {
                    return $loginDialogBox.dialog("widget").effect("shake", {
                      times: 3
                    }, 333);
                  },
                  success: function() {
                    return window.location.replace('/');
                  },
                  cache: false,
                  contentType: false,
                  processData: false
                });
              },
              "Cancel": function() {
                return $loginDialogBox.dialog("close");
              }
            }
          });
        });
        $('#logout').click(function() {
          return $.get('/logout');
        });
        return this;
      };

      return AdminController;

    })();
    if (!window.adminController) {
      window.adminController = new AdminController;
    }
    return window.adminController;
  });

}).call(this);
